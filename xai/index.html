<!DOCTYPE html>
<html lang="en">
<head>

  <title>greysweater42&#39;s cookbook</title>
  <link rel="shortcut icon" type='image/x-icon' href="https://greysweater42.github.io/favicon.ico"/> 

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">        
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css?family=Fascinate&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/bootstrap-toc.css">

  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/darcula.css">

  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/style.css">

</head>


<body data-spy="scroll" data-target="#toc">



<nav id="navbar" class="navbar navbar-expand-md fixed-top navbar-hide transition">

  
  <a class="navbar-brand"></a>

  <button class="navbar-toggler float-xs-right" data-toggle="collapse" data-target="#collapsibleNavbar">
    Menu
  </button>

  <div class="collapse navbar-collapse" id="collapsibleNavbar">

    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://greysweater42.github.io">Home</a>
      </li>
      
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Python</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/basic_pytorch/"> basic pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/beautiful_soup/">beautiful soup</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decorators/">decorators</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fastai/">fastai</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ggplot2/">ggplot(2)</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/sqlalchemy/">sqlAlchemy</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">R</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cinr/">C in R</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rmariadb/">RMariaDB (former RMySQL)</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rcpp/">Rcpp</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/classess4/">classes - S4</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/data.table/">data.table</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/debugging/">debugging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ggplot2/">ggplot(2)</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/lubridate/">lubridate</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/packages/">packages</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rtags/">rTags</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/reshape2/">reshape2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rstanarm/">rstanarm</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/shiny/">shiny</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/sqldf/">sqldf</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tidyverse/">tidyverse</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Data engineering</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/hadoop/">hadoop</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/useful_processing/">useful processing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Machine learning</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/basic_pytorch/"> basic pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/xai/">XAI</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ml/">basic machine learning algorithms</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fastai/">fastai</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/validation/">model validation</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nlp/">nlp</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/useful_processing/">useful processing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/xgboost/">xgboost</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">DevOps</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bash/">bash</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/docker/">docker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/git/">git</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/heroku/">heroku</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/mesos/">mesos</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/vagrant/">vagrant</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Projects</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/finance_nn/">neural networks vs stock market</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/vim_vs_emacs/">vim vs emacs - text mining to settle the editor war</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cookbook/">writing a cookbook</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">scratchpad</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/hugo/">Hugo</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/file/">Rmarkdown total basics</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/caffee/">caffee</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cassandra/">cassandra</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/featuretools/">featuretools</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/gitlab_ci/">gitlab-ci</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/kafka/">kafka</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/linux_tools/">linux tools</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/marathon/">marathon</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/mlops/">mlops</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/passing_arguments/">passing arguments to scripts</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/redis/">redis</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow_serving/">tensorflow_serving</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/theano/">theano</a>
          
        </div>
      </li>
    
    </ul>

  </div>  

</nav>



<div class="jumbotron text-center" id="header">

  <div id="header-title">
      <a href="https://greysweater42.github.io">greysweater42&#39;s cookbook</a>
  </div>

  <p style="color: white;">data science tutorials and snippets prepared by greysweater42</p> 

</div>


<nav id="toc" data-toggle="toc" class="sticky-top d-none d-xl-block"></nav>

<div class="article">

<div class="article-categories">
  
    <object style="vertical-align:middle" type="image/svg+xml" data="/folder.svg" height="15px" width="15px"></object> 
    <a href="https://greysweater42.github.io/categories/machine-learning" role="button">Machine learning </a>
    &emsp;
  </br>
</div>
<div class="article-title">
  
  XAI

</div>
<div class="article-info">
    Nov 22, 2020 &emsp;  &emsp; 5 minutes read
</div>



<h1 id="1-why-even-bother-explaining-machine-learning-models">1. Why even bother explaining machine learning models?</h1>

<ul>
<li><p>users will trust the model which explains their decisions not only because of <a href="https://leversofpersuasion.medium.com/because-to-persuade-give-a-reason-5f532f5b558a#:~:text=WHY%20GIVING%20A%20REASON%20WORKS&amp;text=When%20you%20give%20someone%20a,%5D%20wanted%20to%20do%20anyway.%E2%80%9D">this</a></p></li>

<li><p>you will gain insight on whether the model will perform well on new data, e.g. you may find out that the decision if a photo depicts a husky or a dachshund is based not on features of a dog but on snow that lays all around.</p></li>
</ul>

<h1 id="2-how-to-do-that">2. How to do that?</h1>

<p>The most popular approaches are:</p>

<h3 id="1-shap-https-arxiv-org-abs-1705-07874">1. <a href="https://arxiv.org/abs/1705.07874">SHAP</a></h3>

<p>Useful resources:</p>

<ul>
<li><p><a href="https://arxiv.org/abs/1705.07874">A Unified Approach to Interpreting Model Predictions</a> - a pretty good paper where the original SHAP values are defined, but definitely too complicated to begin with. You should read the three papers listed below. Having read them, you may get back to this one, from which you will learn that SHAP is pretty much Shapley value used in the context of linear regression and that calculating in directly is super ineffective, so some optimization techniques are used.</p>

<ul>
<li><p>lime - as SHAP is a combination of Lime, SHapley value and 4 other methods (actually it is based very heavily on Shapley values, but used in a completely different context) - all the good resources I found are listed below.</p></li>

<li><p><a href="https://www.researchgate.net/publication/229728883_Analysis_of_Regression_in_Game_Theory_Approach">Analysis of regression in game theory approach</a> - where the idea of using Shapley values in regression appeared. There is also a word on why this seems to be a good idea (in linear regression we lack the statistics to measure the importance of <em>groups</em> of coefficients, so we completely forget about &ldquo;synergies&rdquo;, or &ldquo;cooperation/coalition&rdquo;, or &ldquo;multicollinearity&rdquo;). Permutations are explained in a rather straightfoward way, but if you still could not grasp them, then try the next paper.</p></li>

<li><p><a href="http://www.library.fa.ru/files/roth2.pdf">Introduction to the Shapley value</a> - if you have economic background, you will feel at home, as the Shapley the Shapley value is explained here as the average marginal contribution to the score (which is e.g. R squared), and the average is weightd based on the probability that this particular group of coeficients appear together in the model.</p></li>
</ul></li>

<li><p>Reading only the paper above (and its explanatory papers) may be not enough to actually understand how SHAP works, but you will gain a broad understanding of the subject, e.g. where the whole idea came from. To go further, you can read <a href="https://christophm.github.io/interpretable-ml-book/shap.html">this chapter from Interpretable machien learning</a></p></li>
</ul>

<h3 id="2-lime-https-arxiv-org-abs-1602-04938">2. <a href="https://arxiv.org/abs/1602.04938">lime</a></h3>

<p>We pretty much build a linear regression model on predictions. Useful resources:</p>

<ul>
<li><p><a href="https://arxiv.org/abs/1602.04938">the official paper</a>, where the method is presented in mathematical context</p></li>

<li><p><a href="https://github.com/marcotcr/lime">python lime package</a> and its <a href="https://lime-ml.readthedocs.io/en/latest/index.html">docs</a>. Unfortunately after reading docs and github examples I still was not sure how I should interpret the results presented on plots. Anyway it is a good place to start getting familiar with python&rsquo;s lime syntax.</p></li>

<li><p><a href="https://pbiecek.github.io/ema/LIME.html">a chapter fromm Explanatory Model Analysis by pbiecek</a> is the place where I finally understood what lime&rsquo;s plots mean. Even though examples are wriiten in R, the plots are analogical to those produced by lime in python, and there is a mathematical explanation for what you can see in them.</p></li>

<li><p><a href="https://arxiv.org/abs/2001.03447">Explaining the explainer: A First Theoretical Analysis of LIME</a> - an excellent, in-depth analysis oh how lime works on a simple example of linear regression model. Very useful to understand how lime actually works on tabular data and why you shouldn&rsquo;t trust its estimation values! (in a nutshell: results vary significantly depending on your choice of hyperparameter <em>v</em>, i.e. how much &ldquo;local&rdquo; you are, e.g. in Poland living near your parents means within 30km range, in Russia - probably around 300km ;) )</p></li>
</ul>

<p>In general I it was extremely hard to find proper explanation of what actually lime does. Ironically, the &ldquo;explainer&rdquo; which is meant to transform a complex, nonlinear model into an easy to grasp form is very complicated and non-ituitive itself. The cases which I found particurarly obscure are:</p>

<ul>
<li><p>when we calculate the distance between observations we use Gaussian Radial Basis Function (known also as Gaussian kernel - Zaki, Meira, Data Mining ana Analysis, p. 147), we have to choose arbitrarily the value of <code>v</code>. Depending on our choice, the results may vary (how much? - I will address this question below)</p></li>

<li><p>our linear model may turn out to be quite poor. In this case we should not use this method at all. Shouldn&rsquo;t there be a warning somewhere?</p></li>

<li><p>the coefficients of the explainer are rather unexplainable, because</p>

<ul>
<li><p>they depend on how good the linear model fits to the data</p></li>

<li><p>and on our prior choice of <code>v</code></p></li>
</ul></li>

<li><p>subject that is not mentioned often: xgboost manages multicollinearity between variables pretty well, but linear regression unfortunately not. Its coefficients are not stable, so their interpretation is&hellip; risky.</p></li>
</ul>

<p>To sum up, despite my concerns, I like this method. I think it is a brilliant idea to explain the black box models, but we should not be as yolo-optimistic as the authors of the majority of articles on medium.com, towardsdatascience.com etc. are and not treat lime as a magical tool that finally solves the black-box explainability problem. Actually I am quite disappointed that the hype on data science leads to dishonest psuedo-papers and false promises (&ldquo;with lime you can explain any black-box model, because it&rsquo;s model agnostic&rdquo; - rly? although it is true that it is model agnostic, the quality of the explanation may be very poor, even false and misleading if you do not do it carefully; besides in some cases it may not be possible to find a feasible linear approximation. Well, there are some &lsquo;24-hour courses&rsquo; on data science, which may suggest that after 24 hours&hellip; you are a competent data scientist? This is a subject for another discussion ;) )</p>

<h3 id="3-eli5-https-eli5-readthedocs-io-en-latest">3. <a href="https://eli5.readthedocs.io/en/latest/">eli5</a></h3>

<p>TODO</p>

<h3 id="4-cam">4. CAM</h3>

<p>More about CAL you will find in my article on <a href="https://greysweater42.github.io/fastai">fastai</a>.</p>

<h3 id="5-cnn-layers">5. CNN layers</h3>

</div>

<div class="jumbotron text-center" id="footer">

  made using &emsp;
  <br class="d-xl-none">
  <a href="https://gohugo.io/">Hugo</a> |
  <a href="https://getbootstrap.com/">Bootstrap</a> |
  <a href="https://highlightjs.org/">highlightjs</a> |
  <a href="https://bookdown.org/yihui/blogdown/">blogdown</a> |
  <a href="https://fonts.google.com/">Google fonts</a> &emsp;
  <br class="d-xl-none">
  <a href="https://github.com/tomis9/cookbook">github</a> |
  <a href="https://travis-ci.org/tomis9/cookbook">travis-ci</a> <a href="https://travis-ci.org/tomis9/cookbook"><img src="https://api.travis-ci.org/tomis9/cookbook.png"></img></a> |
  <a href="https://hub.docker.com/r/tomis9/cookbook">docker hub</a> &emsp;
  <br class="d-xl-none">
  <a href="https://aws.amazon.com/s3">Amazon S3</a> |
  <a href="https://aws.amazon.com/route53/">Amazon Route 53</a> &emsp;
  <br class="d-xl-none">
  Copyright &copy; 2019 tomis9

</div>

</body>



<script src="https://greysweater42.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


<script src="https://greysweater42.github.io/js/bootstrap-toc.js"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>


<script>
$(window).scroll(function() {
  
  if ($(window).scrollTop() > 100 ) {
    $('.navbar').removeClass('navbar-hide');
    $('.navbar').addClass('navbar-show');
  } else {
    $('.navbar').removeClass('navbar-show');
    $('.navbar').addClass('navbar-hide');
  };   	
});
</script>

</html>

