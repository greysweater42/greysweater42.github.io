<!DOCTYPE html>
<html lang="en">
<head>

  <title>greysweater42&#39;s cookbook</title>
  <link rel="shortcut icon" type='image/x-icon' href="https://greysweater42.github.io/favicon.ico"/> 

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">        
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css?family=Fascinate&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/bootstrap-toc.css">

  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/darcula.css">

  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/style.css">

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NNMCY8RRGL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NNMCY8RRGL');
  </script>

</head>


<body data-spy="scroll" data-target="#toc">



<nav id="navbar" class="navbar navbar-expand-md fixed-top navbar-hide transition">

  
  <a class="navbar-brand"></a>

  <button class="navbar-toggler float-xs-right" data-toggle="collapse" data-target="#collapsibleNavbar">
    Menu
  </button>

  <div class="collapse navbar-collapse" id="collapsibleNavbar">

    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://greysweater42.github.io">Home</a>
      </li>
      
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Python</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/async_thread/">async/threads</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/beautiful_soup/">beautiful soup</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decorators/">decorators</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fastai/">fastai</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ggplot2/">ggplot2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/keras/">keras</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pillow/">pillow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch_basics/">pytorch basics</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/sqlalchemy/">sqlAlchemy</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">R</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cinr/">C in R</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/classess4/">classes - S4</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/data.table/">data.table</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/debugging/">debugging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ggplot2/">ggplot2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/lubridate/">lubridate</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/packages/">packages</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rcpp/">Rcpp</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/reshape2/">reshape2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rmariadb/">RMariaDB (former RMySQL)</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rstanarm/">rstanarm</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rtags/">rTags</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/shiny/">shiny</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/sqldf/">sqldf</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tidyverse/">tidyverse</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Machine learning</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ml/">basic machine learning algorithms</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bayes/">bayes</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bias_variance/">bias/variance trade-off</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cnns/">CNNs</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fastai/">fastai</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fourier/">Fourier transform</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/keras/">keras</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/validation/">model validation</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nlp/">nlp</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pca/">PCA / SVD</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pillow/">pillow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch_basics/">pytorch basics</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/useful_processing/">useful processing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/xai/">XAI</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/xgboost/">xgboost</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Data engineering</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/async_thread/">async/threads</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/hadoop/">hadoop</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rabbimtmq/">RabbimtMQ</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/useful_processing/">useful processing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">DevOps</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bash/">bash</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/docker/">docker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/docker_compose_boilerplate/">docker-compose biolerplate</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/git/">git</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/heroku/">heroku</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/kubernetes/">Kubernetes</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/mesos/">mesos</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/terraform_ec2_vpc/">terraform &#43; EC2 &#43; VPC</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/vagrant/">vagrant</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Projects</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fiat_ferrari/">fiat 126 v ferrari</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/finance_nn/">neural networks vs stock market</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/reading_mate/">reading mate</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/vim_vs_emacs/">vim vs emacs - text mining to settle the editor war</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cookbook/">writing a cookbook</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">scratchpad</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/passing_arguments/">passing arguments to scripts</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/redis/">redis</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow_serving/">tensorflow_serving</a>
          
        </div>
      </li>
    
    </ul>

  </div>  

</nav>



<div class="jumbotron text-center" id="header">

  <div id="header-title">
      <a href="https://greysweater42.github.io">greysweater42&#39;s cookbook</a>
  </div>

  <p style="color: white;">data science tutorials and snippets prepared by greysweater42</p> 

</div>


<nav id="toc" data-toggle="toc" class="sticky-top d-none d-xl-block"></nav>

<div class="article">

<div class="article-categories">
  
    <object style="vertical-align:middle" type="image/svg+xml" data="/folder.svg" height="15px" width="15px"></object> 
    <a href="https://greysweater42.github.io/categories/machine-learning" role="button">Machine learning </a>
    &emsp;
  </br>
</div>
<div class="article-title">
  
  CNNs

</div>
<div class="article-info">
    Nov 5, 2021 &emsp;  &emsp; 7 minutes read
</div>

<h2 id="1-what-are-cnns-and-why-would-you-care">1. What are CNNs and why would you care?</h2>
<p>CNN stands for convolutional neural network, which is a type of artificial neural network used primarily for image classification, detection and segmentation.</p>
<p>CNN also means Cable News Network, or one of the most popular TV networks in US, but who cares.</p>
<h2 id="2-but-what-is-a-convolutionhttpsenwikipediaorgwikiconvolution">2. But what is a <a href="https://en.wikipedia.org/wiki/Convolution">convolution</a>?</h2>
<p>A convolution is a measure of similarity between two functions <em>f(t)</em> and <em>g(t)</em> depending on the moment t, so it actually is another function, <em>h(t)</em>. For continues functions it is defined as an integral over product of all the possible shifts between two functions (shift being usually denoted as $\tau$), hence the definition:</p>
<p>$$ (f * g)(t) = \int f(\tau) g(t-\tau) d\tau $$</p>
<p>If you don&rsquo;t feel confident with this formula, there are plenty of tutorials on youtube, like <a href="https://www.youtube.com/watch?v=N-zd-T17uiE">this one</a>, but to get the full picture I recommend familiarizing yourself with digital signal processing, e.g. Fourier transform or wavelet transform, to get a feeling of how and why signals are processed.</p>
<p>But if you don&rsquo;t feel comfortable with integrals, you may have a look at the discrete case:</p>
<p>$$ (f*g)[n] = \sum_{m=-\infty}^{\infty} f[m]g[n-m] $$</p>
<p>where you can clearly see that a convolution is a function, which is a combination of two functions, and has high values if the two functions are &ldquo;alike&rdquo; at specific moment of time.</p>
<p>For more information you can refer to the beginning of Ian Goodfellow&rsquo;s <em>Deep Learning</em>, chapter 9: Convolutional Networks.</p>
<h2 id="3-simple-examples-of-a-convolution">3. Simple examples of a convolution</h2>
<h3 id="a-implemented-by-hand">a) implemented &ldquo;by hand&rdquo;</h3>
<p>Let&rsquo;s define some data:</p>
<pre><code class="language-{python}" data-lang="{python}">import numpy as np

f = np.zeros(12)
f[8] = 1
f[9] = -1

g = np.array([0., 1., -1., 0.])
</code></pre><p>We defined two simple functions: <em>f</em> ang <em>g</em>, which look exaclty the same at some point. The second one is much shorter though, but this is not a problem for convolution: it simply assumes that the other values of the function are zeroes.</p>
<p>Let&rsquo;s apply a convolution to these functions:</p>
<pre><code class="language-{python}" data-lang="{python}">s = max(len(f), len(g))
x = np.concatenate([np.zeros(s), f, np.zeros(30)])
y = np.concatenate([np.zeros(s), g, np.zeros(len(f) - len(g)), np.zeros(s)])

c = np.zeros(len(f) + len(g) - 1)
for t in range(len(f)):
    for tau in range(-s, s):
        c[t] += x[s+tau] * y[s+t-tau]

print(c)
</code></pre><pre><code>[ 0.  0.  0.  0.  0.  0.  0.  0.  0.  1. -2.  1.  0.  0.  0.]
</code></pre><p>First, we declared a margin called <code>s</code>, which is just for convenience of numpy during shifting. In a loop we multiply specific values of the function, just as in the discrete convolution case, but this time I used variable names for continues convolution: t and tau, instead of n and m.</p>
<p>The convolution has length 15, which is a sum of lengths of domains of f and g, minus 1 (the number of possible combinations, when <em>f</em> and <em>g</em> are in contact).</p>
<h3 id="b-using-numpy">b) using numpy</h3>
<p>Couldn&rsquo;t be easier:</p>
<pre><code class="language-{python}" data-lang="{python}">print(np.convolve(f, g))
</code></pre><pre><code>[ 0.  0.  0.  0.  0.  0.  0.  0.  0.  1. -2.  1.  0.  0.  0.]
</code></pre><p>Same result as before.</p>
<h3 id="c-using-pytorch">c) using pytorch</h3>
<p>Pytorch, being a framework for artifical neural networks, has a function called <em>convolution</em>. Let&rsquo;s see how it works:</p>
<pre><code class="language-{python}" data-lang="{python}">import torch

f = torch.zeros(12)
f[8] = 1
f[9] = -1
g = torch.tensor([0., 1., -1., 0.])

conv = torch.nn.Conv1d(1, 1, (1, 4), bias=False)
conv.weight = torch.nn.Parameter(g.unsqueeze(0).unsqueeze(0).unsqueeze(0))
# batch_size = 1, &quot;image&quot; &quot;depth&quot;: 1 (not RGB), &quot;image&quot; size: 20x1
f = f.unsqueeze(0).unsqueeze(0).unsqueeze(0)
print(conv(f).detach()[0][0][0])
</code></pre><pre><code>tensor([ 0.,  0.,  0.,  0.,  0.,  0., -1.,  2., -1.])
</code></pre><p>In this case we had to <code>unsqueeze</code> (add a dimension) to our function/array several times, so it was perceived as an image of size 20x1, depth 1 and belonging to a batch of size 1, because you use all of these parameters for training a NN and they are the defaults for pytorch.</p>
<p>Curiously, the results are slighlty different for pytorch, comparing to e.g. numpy: it turns out that pytorch uses cross-correlation instead of convolution, which in fact makes no difference, as they are almost exaclty the same transformations (<a href="https://en.wikipedia.org/wiki/Cross-correlation#Properties">just have a look at Wikipedia</a>). A small discussion about this you may find also on <a href="https://stackoverflow.com/questions/66640802/why-are-pytorch-convolutions-implemented-as-cross-correlations">stackoverflow</a>.</p>
<h2 id="4-differences-between-convolutional-and-fully-connected-layers">4. Differences between convolutional and fully-connected layers</h2>
<p>The answer I would have given before deep diving into convolutions:</p>
<blockquote>
<p>Well, these are just completely different things.</p>
</blockquote>
<p>But now, as I got smarter ;), I know that they are surprisingly similar. At first sight the differences are:</p>
<blockquote>
<p>Fully-connected layer takes as input a <em>n</em>-dimensional vector, but a convolutional layer a <em>x</em> by <em>y</em> by <em>d</em> tensor.</p>
</blockquote>
<p>This does not have to be the case. Convolutional layer <em>can</em> take a <em>x</em> by <em>y</em> by <em>d</em> tensor as input, but can also take a <em>n</em>-dimmensional vector. Actually it is widely used for image classification thanks to its shape-awareness.</p>
<blockquote>
<p>Fully-connected layer produces a <em>n</em>-dimensional vector, while convolutional layer a <em>a</em> by <em>b</em> by <em>k</em> tensor (where a ~= (x + padding) / stride etc.) and <em>k</em> is the number of kernels.</p>
</blockquote>
<p>This also does not have to be case. You can set the number of kernels to 1, which would immediately make it more similar to a fully-connected layer and if your input is an <em>n</em>-dimensional vector, the output would also be a <em>n</em>-dimensional vector (it might be <em>n+/-k</em>, depending on specification).</p>
<blockquote>
<p>There are completely different algorithms to produce an output: convolution and matrix multiplication.</p>
</blockquote>
<p><em>Completely</em> is a subjective term, they just are different, yet they share some similarities. In fact we could understand convolution as a specific, selective and iterative kind of matrix multiplication. There are other differences, but IMHO considering a convolution as a remote relative of matrix multiplication is an interesting point of view, which is worth exploring.</p>
<h2 id="5-quirks-in-cnns">5. Quirks in CNNs</h2>
<ul>
<li>
<p>stride and padding</p>
</li>
<li>
<p>pooling</p>
</li>
<li>
<p>activation - this actually works the same</p>
</li>
<li>
<p>XAI works quite well, especially <a href="https://greysweater42.github.io/fiat_ferrari/#6-but-does-it-really-work">grad-cam</a></p>
</li>
<li>
<p>regularization - data augmentation and dropout (should dropout be used for CNNs?)</p>
</li>
</ul>
<h2 id="6-transposed-convolution-and-upsampling">6. Transposed convolution and upsampling</h2>
<p>If you work on image segmentation, you surely come across the idea of &ldquo;upsampling* or *transposed convolution*. In short, image segmentation relies on a concept of encoding (downsampling) an image into a lower dimension and bringing it back to the initial size with decoding (upsampling) to predict a mask (an image where each pixel belongs to a class, usually reflected in color). Downsampling is usually done with *pooling* or convolution with *stride*. Both of these methods have the same effect: they chose every second (for stride=2 or maxpool_size=2) pixel from feature map.</p>
<p>Let&rsquo;s have a look at a modest prove (proving by showing an example is <em>not</em> a proving&hellip;) ok, let&rsquo;s show an example which <em>shows</em> that <code>stride</code> is the same think as taking every n-th element of a tensor:</p>
<pre><code class="language-{python}" data-lang="{python}">import torch
import torch.nn as nn

# unsqueeze(0) n times
u = lambda x, n=3: u(x.unsqueeze(0), n-1) if n &gt; 0 else x

f = torch.zeros(12)
f[8] = 1
f[9] = -1
g = torch.tensor([0.0, 1.0, -1.0, 0.0])

kwargs = dict(in_channels=1, out_channels=1, kernel_size=(1, 4), bias=False)
conv1 = torch.nn.Conv1d(**kwargs)  # stride 1
conv1.weight = torch.nn.Parameter(u(g))
conv2 = torch.nn.Conv1d(**kwargs, stride=2)  # stride 2
conv2.weight = torch.nn.Parameter(u(g))

print(all(conv1(u(f))[0][0][0][::2] == conv2(u(f))[0][0][0]))  # the same
</code></pre><pre><code>True
</code></pre><blockquote>
<p>I used a recurrent unsqueezer, as the only way I found to avoid writing <code>unsqueeze(0).unsqueeze(0).unsqueeze(0)</code>. Theoretically you can use <code>view()</code>, but it works slighlty differently for 2D tensors, so I tend to avoid it (similar to <code>resize</code> as a transformer in torchvision and <code>torch.reshape</code> - may seem like distant relatives, but are used in completely different contexts).</p>
</blockquote>
<p>Now that we&rsquo;ve recollected how downsampling works in CNNs, let&rsquo;s move back to upsampling. There are two popular ways to perform upsampling in pytorch. The easy way:</p>
<pre><code class="language-{python}" data-lang="{python}">print(conv2(u(f)))  # downsampled
upsample = torch.nn.Upsample(scale_factor=(1, 2))
print(upsample(conv2(u(f))))  # back to the previous dimensions
</code></pre><pre><code>tensor([[[[ 0.,  0.,  0., -1., -1.]]]], grad_fn=&lt;ThnnConv2DBackward0&gt;)
tensor([[[[ 0.,  0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.]]]],
       grad_fn=&lt;UpsampleNearest2DBackward1&gt;)
</code></pre><p>The <code>Upsample</code> module can take various parameters depending on how you want the data to be upsampled. The default way presented above simply repeats the value <code>scale_factor</code> n times, just as numpy&rsquo;s <code>np.reapeat</code> function. More on that in <a href="https://pytorch.org/docs/stable/generated/torch.nn.Upsample.html">pytorch docs</a>.</p>
<p>But there is a smarter, learnable approach to upsampling: you can actually use a specific kernel just as if you were doing an operation inverse to convolution (which, mathematically speaking, is not strictly <em>inverse</em>).</p>
<pre><code class="language-{python}" data-lang="{python}">convtrans = torch.nn.ConvTranspose1d(**kwargs, stride=2)
convtrans.weight.data = u(g)
print(convtrans(conv2(u(f))).shape == u(f).shape)  # the same shapes after unpooling/upsampling
print(convtrans(conv2(u(f))))
</code></pre><pre><code>True
tensor([[[[ 0.,  0.,  0.,  0.,  0.,  0.,  0., -1.,  1., -1.,  1.,  0.]]]],
       grad_fn=&lt;SlowConvTranspose2DBackward0&gt;)
</code></pre><p>As you can see, transposed convolution restores the initial size of the tensor, but the tensor has different values, so the operation is not fully <em>inverse</em> (probably there is a way to inverse the kernel properly, but haven&rsquo;t figured it out yet).</p>

</div>

<div class="jumbotron text-center" id="footer">

  made using &emsp;
  <br class="d-xl-none">
  <a href="https://gohugo.io/">Hugo</a> |
  <a href="https://getbootstrap.com/">Bootstrap</a> |
  <a href="https://highlightjs.org/">highlightjs</a> |
  <a href="https://bookdown.org/yihui/blogdown/">blogdown</a> |
  <a href="https://fonts.google.com/">Google fonts</a> &emsp;
  <br class="d-xl-none">
  <a href="https://github.com/greysweater42/cookbook">github</a> |
  <a href="https://pages.github.com/">github pages</a> |
  <br>
  about me: <a href="https://www.linkedin.com/in/tomasz-dyrka-490766127/">LinkedIn</a>

</div>

</body>



<script src="https://greysweater42.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


<script src="https://greysweater42.github.io/js/bootstrap-toc.js"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>


<script>
$(window).scroll(function() {
  
  if ($(window).scrollTop() > 100 ) {
    $('.navbar').removeClass('navbar-hide');
    $('.navbar').addClass('navbar-show');
  } else {
    $('.navbar').removeClass('navbar-show');
    $('.navbar').addClass('navbar-hide');
  };   	
});
</script>

</html>

