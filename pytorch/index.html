<!DOCTYPE html>
<html lang="en">
<head>

  <title>greysweater42&#39;s cookbook</title>
  <link rel="shortcut icon" type='image/x-icon' href="https://greysweater42.github.io/favicon.ico"/> 

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">        
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css?family=Fascinate&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/bootstrap-toc.css">

  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/darcula.css">

  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/style.css">

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NNMCY8RRGL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NNMCY8RRGL');
  </script>

</head>


<body data-spy="scroll" data-target="#toc">



<nav id="navbar" class="navbar navbar-expand-md fixed-top navbar-hide transition">

  
  <a class="navbar-brand"></a>

  <button class="navbar-toggler float-xs-right" data-toggle="collapse" data-target="#collapsibleNavbar">
    Menu
  </button>

  <div class="collapse navbar-collapse" id="collapsibleNavbar">

    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://greysweater42.github.io">Home</a>
      </li>
      
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Python</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/async_thread/">async/threads</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/beautiful_soup/">beautiful soup</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decorators/">decorators</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fastai/">fastai</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ggplot2/">ggplot2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/keras/">keras</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pillow/">pillow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch_basics/">pytorch basics</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/sqlalchemy/">sqlAlchemy</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">R</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cinr/">C in R</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/classess4/">classes - S4</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/data.table/">data.table</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/debugging/">debugging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ggplot2/">ggplot2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/lubridate/">lubridate</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/packages/">packages</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rcpp/">Rcpp</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/reshape2/">reshape2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rmariadb/">RMariaDB (former RMySQL)</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rstanarm/">rstanarm</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rtags/">rTags</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/shiny/">shiny</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/sqldf/">sqldf</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tidyverse/">tidyverse</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Machine learning</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ml/">basic machine learning algorithms</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bayes/">bayes</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bias_variance/">bias/variance trade-off</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cnns/">CNNs</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fastai/">fastai</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/keras/">keras</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/validation/">model validation</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nlp/">nlp</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pca/">PCA / SVD</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pillow/">pillow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch_basics/">pytorch basics</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/useful_processing/">useful processing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/xai/">XAI</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/xgboost/">xgboost</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Data engineering</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/async_thread/">async/threads</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/hadoop/">hadoop</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/useful_processing/">useful processing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">DevOps</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bash/">bash</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/docker/">docker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/git/">git</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/heroku/">heroku</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/kubernetes/">Kubernetes</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/mesos/">mesos</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/vagrant/">vagrant</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Projects</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fiat_ferrari/">fiat 126 v ferrari</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/finance_nn/">neural networks vs stock market</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/reading_mate/">reading mate</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/vim_vs_emacs/">vim vs emacs - text mining to settle the editor war</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cookbook/">writing a cookbook</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">scratchpad</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/passing_arguments/">passing arguments to scripts</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/redis/">redis</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow_serving/">tensorflow_serving</a>
          
        </div>
      </li>
    
    </ul>

  </div>  

</nav>



<div class="jumbotron text-center" id="header">

  <div id="header-title">
      <a href="https://greysweater42.github.io">greysweater42&#39;s cookbook</a>
  </div>

  <p style="color: white;">data science tutorials and snippets prepared by greysweater42</p> 

</div>


<nav id="toc" data-toggle="toc" class="sticky-top d-none d-xl-block"></nav>

<div class="article">

<div class="article-categories">
  
    <object style="vertical-align:middle" type="image/svg+xml" data="/folder.svg" height="15px" width="15px"></object> 
    <a href="https://greysweater42.github.io/categories/python" role="button">Python </a>
    &emsp;
  
    <object style="vertical-align:middle" type="image/svg+xml" data="/folder.svg" height="15px" width="15px"></object> 
    <a href="https://greysweater42.github.io/categories/machine-learning" role="button">Machine learning </a>
    &emsp;
  </br>
</div>
<div class="article-title">
  
  pytorch

</div>
<div class="article-info">
    Feb 17, 2021 &emsp;  &emsp; 5 minutes read
</div>

<h2 id="1-what-is-pytorch-and-why-is-it-interesting">1. What is pytorch and why is it interesting?</h2>
<ul>
<li>
<p>Pytorch is one of the most popular artificial neural network python packages, used mainly for deep learning.</p>
</li>
<li>
<p>Comparing to other NN frameworks, pytorch:</p>
<ul>
<li>
<p>makes using CUDA trivial</p>
</li>
<li>
<p>has excellent abstractions for working with neural networks (dataset, dataloader, nn.Module)</p>
</li>
<li>
<p>works well with Tensorboard</p>
</li>
</ul>
</li>
</ul>
<h2 id="2-a-typical-nn-structure">2. A typical NN structure</h2>
<p>Pytorch NN scripts share a very similar structure: many models used in production environment are even almost exactly the same. Let&rsquo;s have a look at these common components.</p>
<h3 id="dataset">Dataset</h3>
<p>Dataset class presents your data in a python-friendly manner. Having spent some time on processing data, you may have noticed that the most basic characteristics of a dataset are:</p>
<ul>
<li>
<p>its <strong>length</strong>, which means that a dataset actually <em>is</em> a <em>set</em> of rows/observations/items,</p>
</li>
<li>
<p>so you can <strong>extract</strong> any <strong>subset</strong> according to your wish</p>
</li>
<li>
<p>and each dataset usually consists of raw, unprocessed data, where all the rows/observations/items should be <strong>transformed</strong> in exactly the same way right at the start.</p>
</li>
</ul>
<p>Pytorch <code>Dataset</code> class complies with all the specifics above. Let&rsquo;s see a basic example:</p>
<pre><code>from torch.utils.data import Dataset
import pandas as pd

class MyDataset(Dataset):
    def __init__(self, file_path, transform=None):
        self.data = pd.read_csv(file_path)
        self.transform = transform

    def __len__(self):
        return len(self.data)

    def __getitem__(self, idx):
        sample = data.loc[idx]
        if self.transform:
            sample = self.transform(sample)

        return sample
</code></pre><p>Quite often you don&rsquo;t have to create your own Dataset class. You can use one of pytorch&rsquo;s predefined datasets, e.g.  <code>from dataset import Mnist</code> or classes written specifically for handling a particular type of data, e.g. <a href="https://pytorch.org/vision/0.8/datasets.html#imagefolder">ImageFolder</a>.</p>
<p>More on datasets you will find in <a href="https://pytorch.org/tutorials/beginner/data_loading_tutorial.html">pytorch docs</a>.</p>
<h3 id="dataloader">DataLoader</h3>
<p>Once you&rsquo;ve defined your dataset you can concentrate on how to feed the data into your neural network. Pytorch proposes using a handy <code>DataLoader</code> object:</p>
<pre><code>from torch.utils.data import DataLoader
loader = DataLoader(dataset, batch_size=10, shuffle=True)
</code></pre><p>which returns an iterator over your dataset. The arguments to the loader&rsquo;s initializer seem rather self-explanatory, except maybe one of them, which turns out to be particurarily useful: <code>sampler</code>, which can balance the dataset if necessary. More on <code>WeightedRandomSampler</code> you will find in <a href="https://pytorch.org/docs/stable/data.html#torch.utils.data.WeightedRandomSampler">pytorch docs</a>.</p>
<h3 id="neural-net">Neural Net</h3>
<p>We have finally reached the core part of the whole script: the neural network definition. Classically, as most of the neural networks use backpropagation for optimization, neural network performs two types of operation: <strong>forward</strong> and backward passes. Pytorch handles backward pass by itself as a reversed forward pass, however it is us who defines the forward pass, which in practice is equivalent to defining the whole neural network&rsquo;s structure.</p>
<p>An example of a very simple convolutional network:</p>
<pre><code>import torch.nn as nn

IMAGE_SIZE = (64, 64)

class Net(nn.Module):
    def __init__(self):
        super(Net, self).__init__()
        self.features = nn.Sequential(
            nn.Conv2d(in_channels=3, out_channels=32, kernel_size=3, padding=1),
            nn.ReLU(),
            nn.MaxPool2d(2, 2),
        )
        self.fc = nn.Linear(32 * IMAGE_SIZE[0] * IMAGE_SIZE[1], 2)

    def forward(self, x):
        x = self.features(x)
        x = self.fc(x.view(-1, 32 * IMAGE_SIZE[0] * IMAGE_SIZE[1]))
        return x
</code></pre><p>In practice, you often use transfer learning, i.e. instead of learning all the weights by yourself, you load the weights provided by researchers or any external companies to the majority of layers of your network. Example:</p>
<pre><code>import torch.nn as nn
from torchvision import models

class Net(nn.Module):
    def __init__(self):
        super().__init__()
        self.model = models.ResNet50(pretrained=True)
        self.model.fc = nn.Sequential(
            nn.Linear(self.model.fc.in_features, 500),
            nn.ReLU(),
            nn.Dropout(),
            nn.Linear(500, 2),
        )

    def forward(self, x):
        return self.model(x)
</code></pre><p>Models which you can use for transfer learning are briefly described in <a href="https://pytorch.org/vision/stable/models.html">pytorch docs</a>. A more in-depth tutorial you will find in <a href="https://www.amazon.com/Programming-PyTorch-Deep-Learning-Applications/dp/1492045357">Programming PyTorch for Deep Learning</a>, chapter 4.</p>
<h3 id="training-the-model">training the model</h3>
<p>In this tutorial I do not use CUDA anywhere, as I try to keep the examples as simple as possible, but in real life you may be tempted to speed up the training process, despite the relatively high cost of renting a GPU. A minimal example of training a neural net:</p>
<pre><code>net = Net()
optimizer = torch.optim.Adam(net.parameters(), lr=0.0001)
criterion = nn.CrossEntropyLoss()

for i in range(5):
    print(f&quot;Epoch number: {i}&quot;)
    # keep in mind this unpacking works only for batch_size &gt; 1
    for idx, (inputs, labels) in enumerate(train_loader):
        if not idx % 5:
            print(idx)
        outputs = net(inputs)
        loss = criterion(outputs, labels.long())
        optimizer.zero_grad()  # zero the previous gradients
        loss.backward()  # calculates the gradient on weights
        optimizer.step()  # goes down the gradient
</code></pre><h3 id="evaluating-the-model">evaluating the model</h3>
<p>Model evaluation remains a rather difficult subject and deep neural nets are still being considered black boxes, which means that they may behave in unexpected ways under specific circumstances.  In practice, I usually stick to the traditional machine learning techniques used for classification and regression models (ROC curve, precision/recall, accuracy etc.), but as a hobby I keep searching for more informative metrics provided by additional models or algorithms, which I briefly discuss in <a href="https://greysweater42@github.io/explanation">this post on <em>explanation</em></a>.</p>
<p>A trivial example of accuracy measure and confusion matrix:</p>
<pre><code>from sklearn.metrics import confusion_matrix

net.eval()

pos = 0.0
n_all = 0
trues = []
preds = []

for inputs, labels in test_loader:
    outputs = net(inputs)
    pos_loc = sum(torch.max(outputs, 1).indices == labels).item()
    pos += pos_loc
    n_all += len(inputs)
    preds.append(torch.max(outputs, 1).indices.numpy())
    trues.append(labels.numpy())
    print(pos_loc, len(inputs))

print(f&quot;Accuracy: {pos / n_all}&quot;)

print(&quot;Confusion matrix:&quot;)
print(confusion_matrix(np.concatenate(trues), np.concatenate(preds)))
</code></pre><h2 id="3-recommended-resources">3. Recommended resources</h2>
<ul>
<li>
<p>My favourite book on Pytorch is by now <a href="https://www.amazon.com/Programming-PyTorch-Deep-Learning-Applications/dp/1492045357">Programming PyTorch for Deep Learning</a></p>
</li>
<li>
<p>and a legendary book by Ian Goodfellow: <a href="https://www.amazon.com/Deep-Learning-NONE-Ian-Goodfellow-ebook/dp/B01MRVFGX4">Deep Learning (Adaptive Computation and Machine Learning series)</a>, which concentrates mostly on mathematical side of neural networks and (I think) does not even mention Pytorch at all. Worth reading, in any case. Knowing pytorch is useless unless you understand neural networks well.</p>
</li>
</ul>
<h2 id="4-subjects-still-to-cover">4. Subjects still to cover</h2>
<ul>
<li>
<p>data augmentation (TODO)</p>
</li>
<li>
<p>There are two types of transfer learning: feature extraction and fine-tuning, and this blog post could use descriptions of them both (TODO).</p>
</li>
<li>
<p>transfer learning: on which dataset is ResNet50 pretrained? TODO</p>
</li>
<li>
<p>transfer learning: how about a simple example of freezing some layers? TODO</p>
</li>
</ul>

</div>

<div class="jumbotron text-center" id="footer">

  made using &emsp;
  <br class="d-xl-none">
  <a href="https://gohugo.io/">Hugo</a> |
  <a href="https://getbootstrap.com/">Bootstrap</a> |
  <a href="https://highlightjs.org/">highlightjs</a> |
  <a href="https://bookdown.org/yihui/blogdown/">blogdown</a> |
  <a href="https://fonts.google.com/">Google fonts</a> &emsp;
  <br class="d-xl-none">
  <a href="https://github.com/greysweater42/cookbook">github</a> |
  <a href="https://pages.github.com/">github pages</a> |
  <br>
  about me: <a href="https://www.linkedin.com/in/tomasz-dyrka-490766127/">LinkedIn</a>

</div>

</body>



<script src="https://greysweater42.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


<script src="https://greysweater42.github.io/js/bootstrap-toc.js"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>


<script>
$(window).scroll(function() {
  
  if ($(window).scrollTop() > 100 ) {
    $('.navbar').removeClass('navbar-hide');
    $('.navbar').addClass('navbar-show');
  } else {
    $('.navbar').removeClass('navbar-show');
    $('.navbar').addClass('navbar-hide');
  };   	
});
</script>

</html>

