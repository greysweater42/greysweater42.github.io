<!DOCTYPE html>
<html lang="en">
<head>

  <title>greysweater42&#39;s cookbook</title>
  <link rel="shortcut icon" type='image/x-icon' href="https://greysweater42.github.io/favicon.ico"/> 

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">        
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css?family=Fascinate&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/bootstrap-toc.css">

  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/darcula.css">

  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/style.css">

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NNMCY8RRGL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NNMCY8RRGL');
  </script>

</head>


<body data-spy="scroll" data-target="#toc">



<nav id="navbar" class="navbar navbar-expand-md fixed-top navbar-hide transition">

  
  <a class="navbar-brand"></a>

  <button class="navbar-toggler float-xs-right" data-toggle="collapse" data-target="#collapsibleNavbar">
    Menu
  </button>

  <div class="collapse navbar-collapse" id="collapsibleNavbar">

    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://greysweater42.github.io">Home</a>
      </li>
      
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Python</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/async_thread/">async/threads</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/beautiful_soup/">beautiful soup</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decorators/">decorators</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/delta_table/">delta table</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fastai/">fastai</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ggplot2/">ggplot2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/keras/">keras</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pillow/">pillow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch_basics/">pytorch basics</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/sqlalchemy/">sqlAlchemy</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">R</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cinr/">C in R</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/classess4/">classes - S4</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/data.table/">data.table</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/debugging/">debugging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ggplot2/">ggplot2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/lubridate/">lubridate</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/packages/">packages</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rcpp/">Rcpp</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/reshape2/">reshape2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rmariadb/">RMariaDB (former RMySQL)</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rstanarm/">rstanarm</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rtags/">rTags</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/shiny/">shiny</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/sqldf/">sqldf</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tidyverse/">tidyverse</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Machine learning</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ml/">basic machine learning algorithms</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bayes/">bayes</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bias_variance/">bias/variance trade-off</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cnns/">CNNs</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fastai/">fastai</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fourier/">Fourier transform</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/keras/">keras</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/validation/">model validation</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nlp/">nlp</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pca/">PCA / SVD</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pillow/">pillow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch_basics/">pytorch basics</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/useful_processing/">useful processing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/xai/">XAI</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/xgboost/">xgboost</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Data engineering</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow_bigquery/">airflow &#43; BigQuery</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/async_thread/">async/threads</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/delta_table/">delta table</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/hadoop/">hadoop</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rabbimtmq/">RabbimtMQ</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/terraform_bigquery/">terraform &#43; bigquery</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/useful_processing/">useful processing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">DevOps</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bash/">bash</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/docker/">docker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/docker_compose_boilerplate/">docker-compose biolerplate</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/git/">git</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/heroku/">heroku</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/kubernetes/">Kubernetes</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/mesos/">mesos</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/terraform_bigquery/">terraform &#43; bigquery</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/terraform_ec2_vpc/">terraform &#43; EC2 &#43; VPC</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/vagrant/">vagrant</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Projects</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fiat_ferrari/">fiat 126 v ferrari</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/finance_nn/">neural networks vs stock market</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/reading_mate/">reading mate</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/vim_vs_emacs/">vim vs emacs - text mining to settle the editor war</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cookbook/">writing a cookbook</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">scratchpad</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/passing_arguments/">passing arguments to scripts</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/redis/">redis</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow_serving/">tensorflow_serving</a>
          
        </div>
      </li>
    
    </ul>

  </div>  

</nav>



<div class="jumbotron text-center" id="header">

  <div id="header-title">
      <a href="https://greysweater42.github.io">greysweater42&#39;s cookbook</a>
  </div>

  <p style="color: white;">data science tutorials and snippets prepared by greysweater42</p> 

</div>


<nav id="toc" data-toggle="toc" class="sticky-top d-none d-xl-block"></nav>

<div class="article">

<div class="article-categories">
  
    <object style="vertical-align:middle" type="image/svg+xml" data="/folder.svg" height="15px" width="15px"></object> 
    <a href="https://greysweater42.github.io/categories/data-engineering" role="button">Data engineering </a>
    &emsp;
  </br>
</div>
<div class="article-title">
  
  airflow &#43; BigQuery

</div>
<div class="article-info">
    May 16, 2024 &emsp;  &emsp; 4 minutes read
</div>

<h2 id="why-would-you-use-airflow-with-bigquery">Why would you use airflow with BigQuery?</h2>
<p>Because they both work great for creating ELT processes, storing huge amounts of data, and providing a convenient interface to these data in SQL.</p>
<p>A couple of years ago I wrote a short blog post about <a href="https://greysweater42.github.io/airflow/">airflow 1</a>. I also wrote about <a href="https://greysweater42.github.io/terraform_bigquery/">BigQuery</a> and how it works with <code>terraform</code>. You might want to have a look there as well.</p>
<h2 id="prerequsites">Prerequsites</h2>
<p>Before you start working with airflow + GCP, you need to install and configure airflow (I recommend using virtualenv for that):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pip install apache-airflow
pip install <span style="color:#e6db74">&#39;apache-airflow[google]&#39;</span>

airflow inidb
export AIRFLOW_HOME<span style="color:#f92672">=</span>&lt;wherever you want. config files and DAGS will be stored there&gt;
</code></pre></div><p>After that you&rsquo;re ready to run airflow with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">airflow standalone
</code></pre></div><p>In this tutorial we use a local airflow setup. In production you would rather run airflow in docker containers on a remote server, on k8s cluster, or with Google Cloud Composer. From now on you can access airflow at http://127.0.0.1:8080.</p>
<p>Besides airflow, we need to set up GCP connection from our local computer:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcloud auth application-default login
gcloud config set project bigquery-tutorial-xxxxxx
</code></pre></div><p>where <code>bigqeury-tutorial-xxxxxx</code> is GCP project&rsquo;s ID.</p>
<h2 id="a-brief-example-of-how-airflow-and-bigquery-work-together">A brief example of how airflow and BigQuery work together</h2>
<p>This is a very simple EL pipeline, which downloads some example data from the internet, uploads them to a GCP buckets and creates an external BigQuery table to enable users to access these data using SQL.</p>
<img src="https://greysweater42.github.io/airflow_bigquery.drawio.png" style="width: 100%;"/>
<p>The following <code>cars.py</code> file should be stored in <code>$AIRFLOW_HOME/dags</code> folder.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime

<span style="color:#f92672">from</span> airflow <span style="color:#f92672">import</span> DAG
<span style="color:#f92672">from</span> airflow.operators <span style="color:#f92672">import</span> bash
<span style="color:#f92672">from</span> airflow.providers.google.cloud.operators <span style="color:#f92672">import</span> bigquery <span style="color:#66d9ef">as</span> bq, gcs
<span style="color:#f92672">from</span> airflow.providers.google.cloud.transfers <span style="color:#f92672">import</span> local_to_gcs


<span style="color:#75715e"># this is a config external to airflow, so could be stored anywhere but here</span>
params <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#34;bucket_name&#34;</span>: <span style="color:#e6db74">&#34;cars-xxxxxx&#34;</span>,
    <span style="color:#e6db74">&#34;dataset_name&#34;</span>: <span style="color:#e6db74">&#34;cars&#34;</span>,
    <span style="color:#e6db74">&#34;table_name&#34;</span>: <span style="color:#e6db74">&#34;cars&#34;</span>,
    <span style="color:#e6db74">&#34;tmp_file_path&#34;</span>: <span style="color:#e6db74">&#34;/tmp&#34;</span>,
    <span style="color:#e6db74">&#34;location&#34;</span>: <span style="color:#e6db74">&#34;EUROPE-CENTRAL2&#34;</span>,
    <span style="color:#e6db74">&#34;source_url&#34;</span>: <span style="color:#e6db74">&#34;https://raw.githubusercontent.com/abhionlyone/us-car-models-data/master/2013.csv&#34;</span>,
}

<span style="color:#75715e"># schema could be stored in a separate json file, e.g. in a bucket</span>
cars_table_schema <span style="color:#f92672">=</span> [
    {<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;year&#34;</span>, <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;integer&#34;</span>},
    {<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;make&#34;</span>, <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;STRING&#34;</span>},
    {<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;model&#34;</span>, <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;STRING&#34;</span>},
    {<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;body_styles&#34;</span>, <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;STRING&#34;</span>},
]

default_args <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#34;depends_on_past&#34;</span>: False,
    <span style="color:#e6db74">&#34;start_date&#34;</span>: datetime(<span style="color:#ae81ff">2018</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">0</span>),
    <span style="color:#e6db74">&#34;email&#34;</span>: [<span style="color:#e6db74">&#34;test_mail@gmail.com&#34;</span>],
    <span style="color:#e6db74">&#34;email_on_failure&#34;</span>: False,
    <span style="color:#e6db74">&#34;retries&#34;</span>: <span style="color:#ae81ff">0</span>,
}


dag <span style="color:#f92672">=</span> DAG(<span style="color:#e6db74">&#34;cars&#34;</span>, default_args<span style="color:#f92672">=</span>default_args, catchup<span style="color:#f92672">=</span>False)

<span style="color:#75715e"># the path should be stored somewhere else, probably as a parameter</span>
download_file <span style="color:#f92672">=</span> bash<span style="color:#f92672">.</span>BashOperator(
    task_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;download_file&#34;</span>,
    bash_command<span style="color:#f92672">=</span>f<span style="color:#e6db74">&#34;wget {params[&#39;source_url&#39;]}&#34;</span>,
    cwd<span style="color:#f92672">=</span>params[<span style="color:#e6db74">&#34;tmp_file_path&#34;</span>],
    dag<span style="color:#f92672">=</span>dag,
)

create_bucket <span style="color:#f92672">=</span> gcs<span style="color:#f92672">.</span>GCSCreateBucketOperator(
    task_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;create_bucket&#34;</span>,
    bucket_name<span style="color:#f92672">=</span>params[<span style="color:#e6db74">&#34;bucket_name&#34;</span>],
    <span style="color:#75715e"># in production we would rather use MULTI-REGION setting for reliability</span>
    storage_class<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;REGIONAL&#34;</span>,
    location<span style="color:#f92672">=</span>params[<span style="color:#e6db74">&#34;location&#34;</span>],
    dag<span style="color:#f92672">=</span>dag,
)

upload_file_to_bucket <span style="color:#f92672">=</span> local_to_gcs<span style="color:#f92672">.</span>LocalFilesystemToGCSOperator(
    task_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;upload_file_to_bucket&#34;</span>,
    src<span style="color:#f92672">=</span>f<span style="color:#e6db74">&#34;{params[&#39;tmp_file_path&#39;]}/2013.csv&#34;</span>,
    dst<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2013.csv&#34;</span>,
    bucket<span style="color:#f92672">=</span>params[<span style="color:#e6db74">&#34;bucket_name&#34;</span>],
    dag<span style="color:#f92672">=</span>dag,
)

create_dataset <span style="color:#f92672">=</span> bq<span style="color:#f92672">.</span>BigQueryCreateEmptyDatasetOperator(
    task_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;create_dataset&#34;</span>,
    dataset_id<span style="color:#f92672">=</span>params[<span style="color:#e6db74">&#34;dataset_name&#34;</span>],
    exists_ok<span style="color:#f92672">=</span>True,
    location<span style="color:#f92672">=</span>params[<span style="color:#e6db74">&#34;location&#34;</span>],
    dag<span style="color:#f92672">=</span>dag,
)

<span style="color:#75715e"># file specific information could be stored somewhere else. Then we could reuse</span>
<span style="color:#75715e"># this DAG for downloading any data from the internet</span>
create_table <span style="color:#f92672">=</span> bq<span style="color:#f92672">.</span>BigQueryCreateExternalTableOperator(
    task_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;create_external_table&#34;</span>,
    destination_project_dataset_table<span style="color:#f92672">=</span>f<span style="color:#e6db74">&#34;{params[&#39;dataset_name&#39;]}.{params[&#39;table_name&#39;]}&#34;</span>,
    bucket<span style="color:#f92672">=</span>params[<span style="color:#e6db74">&#34;bucket_name&#34;</span>],
    source_objects<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;*.csv&#34;</span>],
    schema_fields<span style="color:#f92672">=</span>cars_table_schema,
    source_format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;CSV&#34;</span>,
    skip_leading_rows<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
    field_delimiter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;,&#34;</span>,
    quote_character<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#34;&#39;</span>,
    dag<span style="color:#f92672">=</span>dag,
)


(
    download_file
    <span style="color:#f92672">&gt;&gt;</span> create_bucket
    <span style="color:#f92672">&gt;&gt;</span> upload_file_to_bucket
    <span style="color:#f92672">&gt;&gt;</span> create_dataset
    <span style="color:#f92672">&gt;&gt;</span> create_table
)
</code></pre></div><h2 id="remarks">Remarks</h2>
<ul>
<li>
<p>Airflow does not provide a convenient <code>destroy</code> functionality, which would allow us to easily get rid of all of the services that we provisioned.</p>
</li>
<li>
<p>Airflow&rsquo;s BigQuery plugin does not have a simple &ldquo;download data with a query functionality&rdquo;, which is a pity. But you can relatively easily create a custom one.</p>
</li>
<li>
<p>In the architecture above we provision resources (bucket, bq dataset, bq table) and provide business logic (how we e.g. query and filter data) at the same time. You might want to have these two types of actions separately. This is why you might want to consider using <code>terraform</code> for creating infrastructure and DDL, and airflow for ELT only. There are also other tools available, like <code>dbt</code> or <code>DataForm</code>.</p>
</li>
<li>
<p>Airflow has a declarative vibe, i.e. it appears you might define this DAG in a yaml file. There even is a <a href="https://github.com/rambler-digital-solutions/airflow-declarative">package which provides such a functionality</a>.</p>
</li>
</ul>
<h2 id="reading-data-from-bigquery">Reading data from BigQuery</h2>
<p>You can check if processing ended successfully in airflow GUI, but you might also want to query the data. There are many ways to do that, e.g. using GCP Console, GCP&rsquo;s CLI (<code>bq</code>) or from Python:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> google.cloud <span style="color:#f92672">import</span> bigquery

client <span style="color:#f92672">=</span> bigquery<span style="color:#f92672">.</span>Client()

<span style="color:#75715e"># Perform a query.</span>
QUERY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    SELECT * FROM `bigquery-tutorial-xxxxxx.cars.cars` 
</span><span style="color:#e6db74">    where make like &#39;Aston Martin&#39;;
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
query_job <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>query(QUERY)  <span style="color:#75715e"># API request</span>
rows <span style="color:#f92672">=</span> query_job<span style="color:#f92672">.</span>result()  <span style="color:#75715e"># Waits for query to finish</span>

df <span style="color:#f92672">=</span> rows<span style="color:#f92672">.</span>to_dataframe()
<span style="color:#66d9ef">print</span>(df)
</code></pre></div><p><em>The example above was heavily insired by <a href="https://cloud.google.com/bigquery/docs/samples/bigquery-query-results-dataframe">BigQuery&rsquo;s documentation</a>.</em></p>
<p>You can also use <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_gbq.html">pandas&rsquo; special function for reading from BigQuery</a>.</p>
<h2 id="cleanup">Cleanup</h2>
<p>After the pipeline ends successfully and you reviewed the results, you might want to delete the resources that the pipeline created in GCP:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gsutil -m rm -r gs://cars-xxxxxx
bq rm -f cars.cars
bq rm -f cars
</code></pre></div><h2 id="resources">Resources</h2>
<ul>
<li>
<p><a href="https://airflow.apache.org/docs/apache-airflow-providers-google/stable/operators/cloud/bigquery.html">airflow&rsquo;s official guide to BigQUery operators</a></p>
</li>
<li>
<p><a href="https://airflow.apache.org/docs/apache-airflow-providers-google/stable/_api/airflow/providers/google/cloud/operators/bigquery/index.html">airflow&rsquo;s documentation</a></p>
</li>
<li>
<p><a href="https://www.manning.com/books/data-pipelines-with-apache-airflow">Data Pipelines with Apache Airflow</a> - If I were to recommend only one resource to learn airflow, that would be this book.</p>
</li>
</ul>

</div>

<div class="jumbotron text-center" id="footer">

  made using &emsp;
  <br class="d-xl-none">
  <a href="https://gohugo.io/">Hugo</a> |
  <a href="https://getbootstrap.com/">Bootstrap</a> |
  <a href="https://highlightjs.org/">highlightjs</a> |
  <a href="https://bookdown.org/yihui/blogdown/">blogdown</a> |
  <a href="https://fonts.google.com/">Google fonts</a> &emsp;
  <br class="d-xl-none">
  <a href="https://github.com/greysweater42/cookbook">github</a> |
  <a href="https://pages.github.com/">github pages</a> |
  <br>
  about me: <a href="https://www.linkedin.com/in/tomasz-dyrka-490766127/">LinkedIn</a>

</div>

</body>



<script src="https://greysweater42.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


<script src="https://greysweater42.github.io/js/bootstrap-toc.js"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>


<script>
$(window).scroll(function() {
  
  if ($(window).scrollTop() > 100 ) {
    $('.navbar').removeClass('navbar-hide');
    $('.navbar').addClass('navbar-show');
  } else {
    $('.navbar').removeClass('navbar-show');
    $('.navbar').addClass('navbar-hide');
  };   	
});
</script>

</html>

