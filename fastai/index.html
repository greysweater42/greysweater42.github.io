<!DOCTYPE html>
<html lang="en">
<head>

  <title>greysweater42&#39;s cookbook</title>
  <link rel="shortcut icon" type='image/x-icon' href="https://greysweater42.github.io/favicon.ico"/> 

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">        
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css?family=Fascinate&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/bootstrap-toc.css">

  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/darcula.css">

  
  <link rel="stylesheet" href="https://greysweater42.github.io/css/style.css">

</head>


<body data-spy="scroll" data-target="#toc">



<nav id="navbar" class="navbar navbar-expand-md fixed-top navbar-hide transition">

  
  <a class="navbar-brand"></a>

  <button class="navbar-toggler float-xs-right" data-toggle="collapse" data-target="#collapsibleNavbar">
    Menu
  </button>

  <div class="collapse navbar-collapse" id="collapsibleNavbar">

    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://greysweater42.github.io">Home</a>
      </li>
      
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Python</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/beautiful_soup/">beautiful soup</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decorators/">decorators</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fastai/">fastai</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ggplot2/">ggplot(2)</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/keras/">keras</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch_basics/">pytorch basics</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/sqlalchemy/">sqlAlchemy</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">R</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cinr/">C in R</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/classess4/">classes - S4</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/data.table/">data.table</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/debugging/">debugging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ggplot2/">ggplot(2)</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/lubridate/">lubridate</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/packages/">packages</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rcpp/">Rcpp</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/reshape2/">reshape2</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rmariadb/">RMariaDB (former RMySQL)</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rstanarm/">rstanarm</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rtags/">rTags</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/shiny/">shiny</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/sqldf/">sqldf</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tidyverse/">tidyverse</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Machine learning</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/ml/">basic machine learning algorithms</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fastai/">fastai</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/keras/">keras</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/validation/">model validation</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nlp/">nlp</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pytorch_basics/">pytorch basics</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/useful_processing/">useful processing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/xai/">XAI</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/xgboost/">xgboost</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Data engineering</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/hadoop/">hadoop</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/useful_processing/">useful processing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">DevOps</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/bash/">bash</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/docker/">docker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/git/">git</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/heroku/">heroku</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/mesos/">mesos</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/vagrant/">vagrant</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Genomics</a>
        <div class="dropdown-menu scrollable-menu">
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Projects</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/fiat_ferrari/">fiat 126 v ferrari</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/finance_nn/">neural networks vs stock market</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/vim_vs_emacs/">vim vs emacs - text mining to settle the editor war</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cookbook/">writing a cookbook</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">scratchpad</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://greysweater42.github.io/caffee/">caffee</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/cassandra/">cassandra</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/featuretools/">featuretools</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/gitlab_ci/">gitlab-ci</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/hugo/">Hugo</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/kafka/">kafka</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/linux_tools/">linux tools</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/marathon/">marathon</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/mlops/">mlops</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/passing_arguments/">passing arguments to scripts</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/redis/">redis</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/file/">Rmarkdown total basics</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/tensorflow_serving/">tensorflow_serving</a>
          
            <a class="dropdown-item" href="https://greysweater42.github.io/theano/">theano</a>
          
        </div>
      </li>
    
    </ul>

  </div>  

</nav>



<div class="jumbotron text-center" id="header">

  <div id="header-title">
      <a href="https://greysweater42.github.io">greysweater42&#39;s cookbook</a>
  </div>

  <p style="color: white;">data science tutorials and snippets prepared by greysweater42</p> 

</div>


<nav id="toc" data-toggle="toc" class="sticky-top d-none d-xl-block"></nav>

<div class="article">

<div class="article-categories">
  
    <object style="vertical-align:middle" type="image/svg+xml" data="/folder.svg" height="15px" width="15px"></object> 
    <a href="https://greysweater42.github.io/categories/python" role="button">Python </a>
    &emsp;
  
    <object style="vertical-align:middle" type="image/svg+xml" data="/folder.svg" height="15px" width="15px"></object> 
    <a href="https://greysweater42.github.io/categories/machine-learning" role="button">Machine learning </a>
    &emsp;
  </br>
</div>
<div class="article-title">
  
  fastai

</div>
<div class="article-info">
    Mar 3, 2021 &emsp;  &emsp; 5 minutes read
</div>

<h2 id="1-what-is-fastai-and-why-would-you-care">1. What is fastai and why would you care?</h2>
<p>It is a deep learning framework built on top of pytorch, which facilitates some frequently used tasks, e.g.:</p>
<ul>
<li>
<p>you can train your model in one line of code (and it works really well)</p>
</li>
<li>
<p>you can easily view your dataset, which is particularly useful when working with images</p>
</li>
<li>
<p>you can easily check where the model had the biggest errors.</p>
</li>
</ul>
<h2 id="2-a-typical-fastai-program">2. A typical fastai program</h2>
<h3 id="dataset-and-dataloader">Dataset and Dataloader</h3>
<p>Just as in <a href="https://greysweater42.github.io/pytorch">pytorch</a>, we begin with dataset and dataloaders. In case of images fastai provides an <code>ImageDataLoaders</code> abstraction, which consists of torch Dataset and DataLoader in one object. Unlike with torch.datasets.ImageFolder, you keep all your images in one folder. Besides, fastai lets us view some images with one simple command: <code>loader.show_batch</code>. The images shown are already transformed with <code>item_tfms</code> (transformation for validation dataset) and <code>batch_tfms</code> (transformation for validation and augmentation). fastai also provides us with a handy <code>aug_transforms</code> default augmentation function, which works surprisingly well out of the box.</p>
<pre><code class="language-{python}" data-lang="{python}">from fastai.vision.all import ImageDataLoaders, Resize, aug_transforms

loader = ImageDataLoaders.from_folder(
    path=&quot;data&quot;, 
    item_tfms=Resize(224), 
    batch_tfms=aug_transforms(), 
    valid_pct=0.2, 
    bs=20
)
loader.show_batch()
</code></pre><h3 id="neural-network-training">Neural network, training</h3>
<p>Probably the most commonly used practice for training deep neural networks is transfer learning, when we train our own network on top of a network already trained on a huge dataset (e.g. resnet34). fastai makes it surprisingly easy to apply this method. In this case we use <code>loader</code> defined in the previous step, instantiate a learner object and run a <code>fine_tune</code> method for 2 epochs. Why fine_tune? Because we merely update the neural network&rsquo;s weights starting with the weights provided by resnet34.</p>
<pre><code>from fastai.vision.all import (
    cnn_learner,
    error_rate,
    resnet34
)

learn = cnn_learner(loader, resnet34, metrics=error_rate)
learn.fine_tune(2)
</code></pre><h3 id="evaluation">Evaluation</h3>
<p>Once we have trained our network, we check how it perfmorms on a validation dataset. We use a <code>ClassificationInterpretation</code> object for this purpose and it&rsquo;s invaluable <code>plot_confusion_matrix</code> and <code>plot_top_losses</code> methods, the names of which are rather self-explanatory.</p>
<pre><code>from fastai.vision.all import ClassificationInterpretation

interp = ClassificationInterpretation.from_learner(learn)
interp.plot_confusion_matrix(figsize=(3, 3), dpi=80)
interp.plot_top_losses(5, nrows=2, ncols=3)
</code></pre><h2 id="3-customizing-fastai-with-pytorch">3. Customizing fastai with pytorch</h2>
<p>In many cases we would rather use a different dataloader, neural network architecture or evaluation metrics, which are not provided by fastai. Overriding these functionalities causes several inconveniences. Lets have a look at some of them.</p>
<h3 id="custom-transformer-dataset-or-dataloader">Custom transformer, dataset or dataloader</h3>
<p>Usually we would rather write our own augmentation transformer instead of using the default one provided by fastai, <code>aug_transforms</code>. To do this, we may learn the whole new bunch of transformers provided by fastai, but we may prefer to use those that we have been using so far, written in pytorch. fastai is built on top of pytorch, after all.
It turns out that in order to do that, you cannot simply replace your fastai transformers with those from torchvision.</p>
<pre><code># DOES NOT WORK - AN EXAMPLE CASE
from fastai.vision.all import ImageDataLoaders, aug_transforms
from torchvision import transforms

transforms = transforms.Compose([transforms.Resize(64, 64), ...])
loader = ImageDataLoaders.from_folder(..., batch_tfms=transforms, ...)
# DOES NOT WORK - AN EXAMPLE CASE
</code></pre><p>You have to create a pytorch DataSet instance, in this case an ImageFolder, and then instantiate a fastai dataloader using its <code>from_dsets</code> class factory method. Then, in order to be able to use ClassificationInterpretation, you should update <code>vocab</code> parameter in both <code>train</code> and <code>valid</code> datasets.</p>
<pre><code>from torchvision.datasets import ImageFolder
from torchvision import transforms
from torch.utils.data import random_split
from fastai.vision.all import DataLoaders
from fastai.data.transforms import CategoryMap

IMAGE_SIZE = (224, 224)
trans = transforms.Compose({
    transforms.Resize(IMAGE_SIZE),
    transforms.ToTensor(),
})
data = ImageFolder(&quot;data&quot;, transform=trans)

train_len = int(len(data) * 0.8)
valid_len = len(data) - train_len
train, valid = random_split(data, lengths=[train_len, valid_len])
# for torch compatibility with ClassificationIntepretation
train.vocab, valid.vocab = CategoryMap(data.classes), CategoryMap(data.classes)  

dls = DataLoaders.from_dsets(train, valid, bs=20)
</code></pre><h3 id="custom-neural-network-architecture">Custom neural network architecture</h3>
<p>Sometimes you may not want to use transfer learning or use it in a special way, e.g. freezing only specific layers. As fastai is built on top of pytorch, you can train your models on your own net architecture. In this case you define you own learner using a Learner object and train it with a <code>fit_one_cycle</code> method, which has a slightly misleading name: you provide the number of epochs (in the example below it is 10) and you can also choose the maximum learning rate, as after each epoch fastai chooses the best learning rate using its clever <a href="https://fastai1.fast.ai/callbacks.lr_finder.html">learning rate finder</a>. Unfortunately <code>plot_top_losses</code> no longer works.</p>
<pre><code>from fastai.vision.all import Adam, nn, Learner, CrossEntropyLossFlat, accuracy

class Net(nn.Module):
    def __init__(self):
        super(Net, self).__init__()
        out_channels = 32
        max_pool = 2
        self.features = nn.Sequential(
            nn.Conv2d(in_channels=1, out_channels=out_channels, kernel_size=3, padding=1),
            nn.ReLU(),
            nn.MaxPool2d(max_pool, max_pool),
        )
        self.out_size = int(out_channels * IMAGE_SIZE[0] * IMAGE_SIZE[1] / (max_pool ** 2))
        self.fc = nn.Linear(self.out_size, 2)

    def forward(self, x):
        x = self.features(x)
        x = self.fc(x.view(-1, self.out_size))
        return x

learn = Learner(dls, Net(), loss_func=CrossEntropyLossFlat(), opt_func=Adam, metrics=[accuracy])
learn.fit_one_cycle(10, 0.001)
</code></pre><h2 id="4-interesting-resources">4. Interesting resources</h2>
<ul>
<li>
<p>Most of the stuff about fastai I&rsquo;ve learned from <a href="https://www.amazon.com/Deep-Learning-Coders-fastai-PyTorch/dp/1492045527">Deep Learning for Coders with fastai and PyTorch</a>. Unfortunately this book is targeted at beginners in programming and machine learning, so if you move from pytorch to fastai, you will end up skipping 95% of the content. But the remaining 5% is purely useful.</p>
</li>
<li>
<p>You can also have a look at <a href="https://docs.fast.ai/">fastai docs</a>, which were not particularly useful for me. My issues turned out to be rather unusual (moving from pytorch to fastai).</p>
</li>
<li>
<p>And there is also official <a href="https://www.fast.ai/">fastai&rsquo;s webpage</a> with its mission clearly explained: <em>Making neural nets uncool again</em> ;)</p>
</li>
</ul>

</div>

<div class="jumbotron text-center" id="footer">

  made using &emsp;
  <br class="d-xl-none">
  <a href="https://gohugo.io/">Hugo</a> |
  <a href="https://getbootstrap.com/">Bootstrap</a> |
  <a href="https://highlightjs.org/">highlightjs</a> |
  <a href="https://bookdown.org/yihui/blogdown/">blogdown</a> |
  <a href="https://fonts.google.com/">Google fonts</a> &emsp;
  <br class="d-xl-none">
  <a href="https://github.com/tomis9/cookbook">github</a> |
  <a href="https://travis-ci.org/tomis9/cookbook">travis-ci</a> <a href="https://travis-ci.org/tomis9/cookbook"><img src="https://api.travis-ci.org/tomis9/cookbook.png"></img></a> |
  <a href="https://hub.docker.com/r/tomis9/cookbook">docker hub</a> &emsp;
  <br class="d-xl-none">
  <a href="https://aws.amazon.com/s3">Amazon S3</a> |
  <a href="https://aws.amazon.com/route53/">Amazon Route 53</a> &emsp;
  <br class="d-xl-none">
  Copyright &copy; 2019 tomis9

</div>

</body>



<script src="https://greysweater42.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


<script src="https://greysweater42.github.io/js/bootstrap-toc.js"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>


<script>
$(window).scroll(function() {
  
  if ($(window).scrollTop() > 100 ) {
    $('.navbar').removeClass('navbar-hide');
    $('.navbar').addClass('navbar-show');
  } else {
    $('.navbar').removeClass('navbar-show');
    $('.navbar').addClass('navbar-hide');
  };   	
});
</script>

</html>

